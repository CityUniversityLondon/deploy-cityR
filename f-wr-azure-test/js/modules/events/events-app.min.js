CITY.events=function(m){var t=function(e,t){var a=e.Model.extend({}),n=!!$(".events-home").length,s=Backbone.Collection.extend({model:a,url:function(){var e="/api/search.json?collection=city-events&meta_P_orsand=%22Yes%22&landing=true&sort=adate&_=1373022367687",t=$("div.event-calendar-wrap").data("department"),a=$("div.event-calendar-wrap").data("category");if(null!=t&&(e+="&meta_F_orsand=%22"+t+"%22"),null!=a&&(e+="&meta_y_orsand=%22"+a+"%22"),m.location.search){var n=m.location.search.match(/[\?&](meta_E_orsand=[^&]+)(&|$)/);n&&(e+="&"+n[1]),console.log(e)}return e},parse:function(e){var t=[];return e.response&&e.response.resultPacket&&_.each(e.response.resultPacket.results,function(e){var a={};_.each(e,function(e,t){if(_.isObject(e))_.each(e,function(e,t){a[t]=e});else if(_.isArray(e)){if(!e.length)return;a[t]=e}else a[t]=e}),t.push(a)}),t}}),i=function(e,t){return 32-new Date(t,e,32).getDate()},l=function(e){if(this.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.dday="",this.dmonth="",this.dyear="",!(!e instanceof Date))return this.dday=e.getDate().toString(10),this.dmonth=this.months[e.getMonth()],this.dyear=e.getFullYear().toString(10),1===this.dday.length&&(this.dday="0"+this.dday),{dday:this.dday,dmonth:this.dmonth,dyear:this.dyear,dateString:this.dday+"-"+this.dmonth+"-"+this.dyear}},o=['<ul class="clearfix filter-list">','<li><a class="calendar-link filter" id="reset" href="/<%= attrs.pathname %>/calendar#reset/reset" data-param=\'reset\' data-href="reset">All upcoming events</a></li>','<li><a class="calendar-link filter" href="/<%= attrs.pathname %>/calendar#show/equalTo/<%= attrs.fbToday.dateString %>" data-param=\'show/equalTo\' href=\'\' data-href="<%= attrs.fbToday.dateString %>">Today</a></li>','<li><a class="calendar-link filter" href="/<%= attrs.pathname %>/calendar#show/max/<%= attrs.weekEnd.dateString %>" data-param=\'show/max\' href=\'\' data-href="<%= attrs.weekEnd.dateString %>">This week</a></li>','<li><a class="calendar-link filter" href="/<%= attrs.pathname %>/calendar#show/max/<%= attrs.fbEndOfMonth.dateString %>" data-param=\'show/max\' href=\'\' data-href="<%= attrs.fbEndOfMonth.dateString %>">This month</a></li>',"</ul>"].join("\n"),r=t.ItemView.extend({el:$("#calendar-links"),initialize:function(){_.bindAll(this,"render"),this.render()},template:function(){return this.noOfDaysFromNow=new Date,this.today=new Date,this.endOfMonthObj=new Date(this.today.getFullYear(),this.today.getMonth(),i(this.today.getMonth(),this.today.getFullYear())),this.fbEndOfMonth=l(this.endOfMonthObj),this.fbToday=l(this.today),this.weekEnd=l(function(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+6-e.getDay())}(this.today)),this.pathname=m.location.pathname.split("/")[1],_.template(o,this,{variable:"attrs"})}}),c=Backbone.View.extend({el:$("#calendar"),initialize:function(){_.bindAll(this,"render"),this.render()},render:function(){$(this.el).append(this.calendarBuild(this.$el))},calendarBuild:function(e){var t=this,a=0;for(this.calendar=e,this.fbUrl="/api/search.json?collection=city-events&sort=adate&meta_P_orsand=%22Yes%22&form=calendar&date=all&landing=true",this.noOfDaysFromNow=new Date,this.today=new Date,this.endOfMonthObj=new Date(this.today.getFullYear(),this.today.getMonth(),i(this.today.getMonth(),this.today.getFullYear())),this.fbEndOfMonth=l(this.endOfMonthObj),this.fbToday=l(this.today),this.noOfDaysFromNow.setDate(this.noOfDaysFromNow.getDate()+365),this.results=this.collection.models,this.resultsLength=this.results.length,this.eventDates=[];a<this.resultsLength;a++)this.results[a].attributes.d&&this.eventDates.push($.datepicker.parseDate("yy-mm-dd",this.results[a].attributes.d).setHours(0,0,0,0));this.calendar.datepicker({onSelect:function(e,t){if(n){var a="/calendar#show/equalTo/"+t.currentDay+"-"+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.currentMonth]+"-"+t.currentYear;m.location.href+=a}},maxDate:this.noOfDaysFromNow,minDate:0,beforeShowDay:function(e){return-1!==$.inArray(e.setHours(0,0,0,0),t.eventDates)?[!0,"selectable"]:[!1]}}),e.removeClass("component-loading").children(".loading-fa-icon").remove()}}),d=m.EventsAPP;d.collections.calendarCollection=new s,d.collections.calendarCollection.fetch({success:function(){d.views.linksView=new r({collection:d.collections.calendarCollection}),d.views.calendarView=new c({collection:d.collections.calendarCollection})}}),$(".event-calendar-wrap").length&&h(Backbone,Backbone.Marionette)},h=function(e,t){function a(e){CITY.debug(e)}var n=e.Model.extend({}),s={$body:$("html, body"),$filters:$(".filters"),$summary:$("#fb-summary")},i=function(){s.$body.hasClass("screen-thin")&&s.$body.animate({scrollTop:s.$summary.offset().top},400)},l=Backbone.Paginator.clientPager.extend({model:n,initialize:function(){this.on("all",function(e){a("events collection event fired: "+e)})},paginator_core:{dataType:"json",url:"/api/search.json"},paginator_ui:{perPage:100},server_api:{collection:"city-events",landing:"true",sort:"adate",meta_P_orsand:"Yes",meta_F_orsand:function(){if(null!=$("div.event-calendar-wrap").data("department"))return"%22"+$("div.event-calendar-wrap").data("department")+"%22"},meta_y_orsand:function(){if(null!=$("div.event-calendar-wrap").data("category"))return"%22"+$("div.event-calendar-wrap").data("category")+"%22"}},parse:function(e){var t=[];return e.response&&e.response.resultPacket&&_.each(e.response.resultPacket.results,function(e){var a={};_.each(e,function(e,t){if(_.isObject(e))_.each(e,function(e,t){a[t]=e});else if(_.isArray(e)){if(!e.length)return;a[t]=e}else a[t]=e}),t.push(a)}),t},searchFunnelback:function(e){var t=decodeURIComponent($.param(_.extend(this.server_api,{query:e}))),a=this;this.fetch({success:function(){a.sortedAndFilteredModels=a.models.slice(),a.info()},data:t})}}),o=['<div class="event-top cf">','<div class="date">','<p class="date-month"><% var eventMonth = data.H.substring(0, 3); %><%= eventMonth %></p>','<p class="date-day-no"><%= data.G %></p>','<p class="date-day"><%= data.K %></p>',"</div>",'<div class="event-details">','<h2 itemprop="name" class="event-title"><a href="',"<% if (data.Y) { %>","<%= data.Y %>","<% } else { %>","<%= data.liveUrl %>",'<% } %>"','class="summary url" itemprop="url"><%= data.title %></a></h2>','<time itemprop="startDate" datetime="<%= data.B %>z" class="event-time"><i class="fa fa-clock-o"></i>',"<% if (data.Q) { %>","<%= data.Q %><%= data.U %>","<% } else { %>","<%= data.J %>","<% } %>","</time>","<% if (data.y) { %>",'<p class="event-category"><i class="fa fa-tag"></i> <%= data.y %></p>',"<% } %>","<% if (data.M) { %>",'<p class="event-audience"><i class="fa fa-users"></i> <%= data.M %></p>',"<% } %>","</div>","</div>",'<p class="event-summary" itemprop="description"><%= data.c %></p>'].join("\n"),r=t.ItemView.extend({tagName:"li",className:"event vevent",attributes:{itemtype:"http://schema.org/Event",itemscope:""},template:function(e){return _.template(o,e,{variable:"data"})}}),c=t.CollectionView.extend({el:"#events-results",itemView:r,firstRender:!0,initialize:function(){this.$el.empty(),this.$el.addClass("backbone-ready"),this.$el.show(),this.on("render",this.removeSpinners)},removeSpinners:function(){this.$el.removeClass("component-loading").children(".loading-fa-icon").remove()}}),d=e.View.extend({el:"#calendar-links",events:{"click li a":"filterClick"},filterClick:function(e){var t=$(e.target),a=t.data("param")+"/"+t.data("href"),n=t.hasClass("selected");e.preventDefault(),s.$filters.find("a").removeClass("selected"),"reset"===t.data("href")||n?a="clear":t.addClass("selected"),p.router.navigate(a,{trigger:!0}),i()}}),h=e.View.extend({el:"#categories",events:{"click li a":"filterClick"},filterClick:function(e){var t=$(e.target),a=t.attr("href"),n=t.hasClass("selected");e.preventDefault(),$(".filters").find("a").removeClass("selected"),"reset"===t.data("href")||n?a="clear":t.addClass("selected"),p.router.navigate(a,{trigger:!0}),i()}}),f=e.View.extend({el:"#calendar",events:{"mousedown td a":"facetClick"},facetClick:function(e){var t=$(e.target),a="show/equalTo/"+encodeURIComponent(t.text())+"-"+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][encodeURIComponent(t.parent().data("month"))]+"-"+t.parent().data("year");e.preventDefault(),p.router.navigate(a,{trigger:!0}),i()}}),u=t.ItemView.extend({el:".results-summary",collectionEvents:{sync:"render",reset:"render",sort:"render"},template:function(e){return e.info=p.collections.eventsCollection.information,_.template("<span class='results-totals'><%= info.startRecord %> - <%= info.endRecord %> of <%= info.totalRecords %> results</span>",e)}}),v=e.Router.extend({routes:{clear:"defaultRoute","show/:param/:value":"showRoute","search/:param/:value":"searchRoute"},initialize:function(){p.collections.eventsCollection.once("sync",function(){a("starting router"),$(function(){e.history.start({root:m.location.pathname})})}),p.collections.eventsCollection.fetch({success:function(){p.collections.eventsCollection.pager()},silent:!0})},defaultRoute:function(){$(".no-results").remove(),$(".filters").find("a").removeClass("selected"),$("#reset").addClass("selected"),p.collections.eventsCollection.setFieldFilter()},searchRoute:function(e,a){$(".no-results").remove(),a=a.replace("+"," ").match(/[\w ]/g).join(""),p.collections.eventsCollection.setFieldFilter([{field:e,type:"equalTo",value:a}]),p.collections.eventsCollection.length||$("#events-results").append('<li class="no-results"><h2>No upcoming events of this type</h2><p class="cta soft-cta"><a class="reset" href="#clear">Reset filters</a></p></li>'),$.each($("#category-select").find("a"),function(e,t){$(t).data("href").replace("+"," ").match(/[\w ]/g).join("")===a&&$(t).addClass("selected")})},showRoute:function(a,n){var e=n.split("-");$(".no-results").remove(),p.collections.eventsCollection.setFieldFilter([{field:"G",type:a,value:e[0]},{field:"H",type:"pattern",value:e[1]},{field:"I",type:a,value:e[2]}]),s.$filters.find("a").removeClass("selected"),$.each($("#calendar-links").find("a"),function(e,t){$(t).data("href")!==n&&$(t).data("param")!==a||$(t).addClass("selected")}),p.collections.eventsCollection.length||$("#events-results").append('<li class="no-results"><h2>No events for this period are availiable to show</h2><p class="cta soft-cta"><a class="reset" href="#clear">Reset filters</a></p></li>')}}),p=m.EventsAPP;p.collections.eventsCollection=new l,p.views.searchMetaView=new u({collection:p.collections.eventsCollection}),p.views.eventsListView=new c({collection:p.collections.eventsCollection}),p.views.facetsView=new f({collection:p.collections.eventsCollection}),p.views.linksActionView=new d,p.views.catLinksActionView=new h,p.router=new v};return{init:function(){var e={collections:{calendarCollection:void 0,eventsCollection:void 0},views:{linksView:void 0,categoryView:void 0,linksActionView:void 0,calendarView:void 0,eventsListView:void 0,facetsView:void 0},router:void 0};m.EventsAPP=e,$("#calendar").length&&t(Backbone,Backbone.Marionette),$(".single-event").length&&function(){var e,t,a,n,s;e=$("#booking-form"),t=$(".event-book"),a=function(){e.addClass("show"),$("html, body").animate({scrollTop:e.offset().top},500)},t.on("click",function(e){e.preventDefault(),a()}),(e.find(".wFormThankYou").length||e.find(".errorMessage").length)&&a(),n=$("#related-events"),s=n.find("ul"),n&&s.bxSlider({slideWidth:320,minSlides:1,maxSlides:3,slideMargin:30,moveSlides:1,infiniteLoop:!1,nextText:'<i class="fa fa-caret-right"></i>',prevText:'<i class="fa fa-caret-left"></i>',touchEnabled:!0,preventDefaultSwipeY:!0,adaptiveHeight:!1,pager:!1,hideControlOnEnd:!0,responsive:!0})}(),$(".events-home").length&&$("#primary-nav-toggler").addClass("events-home-title")}}}(window),CITY.events.init();