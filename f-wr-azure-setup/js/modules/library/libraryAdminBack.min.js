var libraryAdmin=function(c){"use strict";var p,a,u,f,e,d,t=[],s=c(".add-exception"),n=c(".start-full-date"),r=c(".open-status"),i=c("#notice-text").attr("data-libraryid");return{init:function(){t.key="1319678258",p=new Squiz_Matrix_API(t),s.click(function(){var e=c(this);e.siblings(".open-date").toggleClass("exception-container"),e.siblings(".closed-date").toggleClass("exception-container"),e.toggleClass("add-exception-show")}),r.change(function(){var e=c(this),a=e.parent(".recurring-container"),t=e.parents(".edit-opening-times-item");"open"===e.val()?(t.children(".closed-date").addClass("hide"),t.children(".open-date").removeClass("hide"),a.removeClass("recurring-closed").addClass("recurring-open"),a.children(".day-details").removeClass("hide")):("twentyfour"===e.val()?(t.children(".closed-date").addClass("hide"),t.children(".open-date").removeClass("hide"),a.removeClass("recurring-closed").addClass("recurring-open")):(t.children(".closed-date").removeClass("hide"),t.children(".open-date").addClass("hide"),a.removeClass("recurring-open").addClass("recurring-closed")),a.children(".day-details").addClass("hide"))}),c(".recurring-container .action-button").click(function(){var e,a,t,s,n=[],r=c(this),i=r.parents(".edit-opening-times-item"),d=i.children(".recurring-container"),l=d.find(".open-status"),o=d.attr("id");r.fadeOut("slow"),i.find(".ajax-loader").fadeIn("slow"),d.siblings(".admin-error").remove(),"close"===l.val()?(i.find(".open-exceptions li").each(function(e){n[e]=c(this).attr("id")}),p.trashAsset({asset_ids:n,dataCallback:function(){p.setAssetStatus({asset_id:o,status:2,cascade:0,dataCallback:function(e){e.error&&d.after("<p class='admin-error'>There was an error changing the status of the library to 'closed' for this day. Please try again.</p>").hide().show("slow"),i.find(".ajax-loader").fadeOut("slow"),r.fadeIn("slow")}})}})):(a=(s=i.find(".year, .month, .day, .day-details .open-start-hours, .day-details .open-start-minutes, .day-details .open-end-hours, .day-details .open-end-minutes"))[0].textContent+"-"+s[1].textContent+"-"+s[2].textContent+" "+s[3].value+":"+s[4].value+":00",t=s[0].textContent+"-"+s[1].textContent+"-"+s[2].textContent+" "+s[5].value+":"+s[6].value+":00",e="twentyfour"===l.val()?"yes":"no",p.setMetadataAllFields({asset_id:o,field_info:{469909:a,469915:t,469908:e},dataCallback:function(e){e.success||d.after("<p class='admin-error'>There was an error updating the times for this day. Please try again.</p>").hide().show("slow"),p.setAssetStatus({asset_id:o,status:16,cascade:0,dataCallback:function(){i.find(".closed-exceptions li").each(function(e){n[e]=c(this).attr("id")}),p.trashAsset({asset_ids:n,dataCallback:function(){i.find(".ajax-loader").fadeOut("slow"),r.fadeIn("slow")}})}})}}))}),c(".change-exception").click(function(){var e,t,s,n=c(this),r=n.parent(".open-change-exception"),i=n.parents(".edit-opening-times-item"),d=r.find(".start-full-date, .start-hours, .start-minutes, .end-hours, .end-minutes"),l=r.parent(".open-date").siblings(".recurring-open").children(".week-day").text(),o=r.children(".24h-selector").is(":checked");n.fadeOut("slow"),i.find(".ajax-loader").fadeIn("slow"),i.find(".admin-error").remove(),s=!0===o?"yes":"no",e=c(d[0]).val().split("-")[2]+"-"+c(d[0]).val().split("-")[1]+"-"+c(d[0]).val().split("-")[0],f=e+" "+c(d[1]).val()+":"+c(d[2]).val()+":00",t=e+" "+c(d[3]).val()+":"+c(d[4]).val()+":00",a="start_date="+e,p.createAsset({parent_id:r.parents(".edit-opening-times-item").find(".recurring-container").attr("id"),type_code:"calendar_event_modification",asset_name:l,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:a,dataCallback:function(a){a.error?(i.append("<p class='admin-error'>There was an error creating this exception. Please try again.</p>"),r.children(".start-full-date").val("dd-mm-yyyy"),i.find(".ajax-loader").fadeOut("slow"),n.fadeIn("slow")):p.setMetadataAllFields({asset_id:a.id,field_info:{469909:f,469915:t,469908:s},dataCallback:function(e){e.success?p.setAssetStatus({asset_id:a.id,status:16,cascade:0,dataCallback:function(e){e.error?(p.trashAsset({asset_ids:a.id}),i.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: status change error, asset "+a.id+" created and moved to trash)</p>")):(u=!1===o?'<li id="'+a.id+'" class="exception-item"><span class="event-container add-event">Opened on '+l.substring(0,l.length-1)+' <span class="open-full-day">'+c(d[0]).val()+'</span><span class="extra-content"> from </span><span class="open-start">'+c(d[1]).val()+":"+c(d[2]).val()+'</span><span class="extra-content"> to </span><span class="open-end">'+c(d[3]).val()+":"+c(d[4]).val()+'</span></span><span class="remove-date"> remove</span></li>':'<li id="'+a.id+'" class="exception-item"><span class="event-container add-event">Opened on '+l.substring(0,l.length-1)+' <span class="open-full-day">'+c(d[0]).val()+'</span><span class="extra-content"> for 24 hours</span><span class="remove-date"> remove</span></li>',r.siblings(".open-exceptions").append(u).hide().fadeIn("slow")),r.children(".start-full-date").val("dd-mm-yyyy"),i.find(".ajax-loader").fadeOut("slow"),n.fadeIn("slow")}}):(p.trashAsset({asset_ids:a.id}),i.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: metadata set error, asset "+a.id+" created and moved to trash)</p>"),r.children(".start-full-date").val("dd-mm-yyyy"),i.find(".ajax-loader").fadeOut("slow"),n.fadeIn("slow"))}})}})}),c(".close-exception").click(function(){var t=c(this),s=t.parent(".open-del-exception"),e=s.find(".start-full-date"),n=t.parents(".edit-opening-times-item"),r=s.parent(".open-date").siblings(".recurring-open").children(".week-day").text();t.fadeOut("slow"),n.find(".ajax-loader").fadeIn("slow"),n.find(".admin-error").remove(),f=e.val().split("-")[2]+"-"+e.val().split("-")[1]+"-"+e.val().split("-")[0],a="start_date="+f,p.createAsset({parent_id:s.parents(".edit-opening-times-item").find(".recurring-container").attr("id"),type_code:"calendar_event_cancellation",asset_name:r,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:a,dataCallback:function(a){a.error?(n.append("<p class='admin-error'>There was an error creating this exception. Please try again.</p>"),s.children(".start-full-date").val("dd-mm-yyyy"),n.find(".ajax-loader").fadeOut("slow"),t.fadeIn("slow")):p.setAssetStatus({asset_id:a.id,status:16,cascade:0,dataCallback:function(e){e.error?(p.trashAsset({asset_ids:a.id}),n.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: status change error, asset "+a.id+" created and moved to trash)</p>")):(u='<li id="'+a.id+'" class="exception-item"><span class="event-container add-event">Closed on '+r.substring(0,r.length-1)+' <span class="open-full-day">'+f+'</span></span><span class="remove-date"> remove</span></li>',s.siblings(".open-exceptions").append(u).hide().fadeIn("slow")),s.children(".start-full-date").val("dd-mm-yyyy"),n.find(".ajax-loader").fadeOut("slow"),t.fadeIn("slow")}})}})}),c(".open-exception").click(function(){var t=c(this),s=t.parents(".edit-opening-times-item"),n=t.parent(".closed-create-exception"),r=n.find(".start-full-date, .start-hours, .start-minutes, .end-hours, .end-minutes"),i=n.parent(".closed-date").siblings(".recurring-closed").children(".week-day").text();t.fadeOut("slow"),s.find(".ajax-loader").fadeIn("slow"),s.find(".admin-error").remove(),e=c(r[0]).val().split("-")[2]+"-"+c(r[0]).val().split("-")[1]+"-"+c(r[0]).val().split("-")[0],f=e+" "+c(r[1]).val()+":"+c(r[2]).val()+":00",d=e+" "+c(r[3]).val()+":"+c(r[4]).val()+":00",a="start_date="+f+"&end_date="+d,p.createAsset({parent_id:n.parents(".edit-opening-times-item").find(".recurring-container").attr("id"),type_code:"calendar_event_single",asset_name:i,link_type:1,link_value:"",sort_order:1,is_dependant:0,is_exclusive:0,extra_attributes:1,attributes:a,dataCallback:function(a){a.error?(s.append("<p class='admin-error'>There was an error creating this exception. Please try again.</p>"),n.children(".start-full-date").val("dd-mm-yyyy"),s.find(".ajax-loader").fadeOut("slow"),t.fadeIn("slow")):p.setMetadataAllFields({asset_id:a.id,field_info:{469909:f,469915:d},dataCallback:function(e){e.error?(p.trashAsset({asset_ids:a.id}),s.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: metadata set error, asset "+a.id+" created and moved to trash)</p>"),n.children(".start-full-date").val("dd-mm-yyyy"),s.find(".ajax-loader").fadeOut("slow"),t.fadeIn("slow")):p.setAssetStatus({asset_id:a.id,status:16,cascade:0,dataCallback:function(e){e.error?(p.trashAsset({asset_ids:a.id}),s.append("<p class='admin-error'>There was an error creating this exception, please try again. <br />(note for developer: status change error, asset "+a.id+" created and moved to trash)</p>")):(u='<li id="'+a.id+'" class="exception-item"><span class="event-container add-event">Opened on '+i.substring(0,i.length-1)+' <span class="open-full-day">'+c(r[0]).val()+'</span><span class="extra-content"> from </span><span class="open-start">'+c(r[1]).val()+":"+c(r[2]).val()+'</span><span class="extra-content"> to </span><span class="open-end">'+c(r[3]).val()+":"+c(r[4]).val()+'</span></span><span class="remove-date"> remove</span></li>',n.siblings(".closed-exceptions").append(u).hide().fadeIn("slow")),n.children(".start-full-date").val("dd-mm-yyyy"),s.find(".ajax-loader").fadeOut("slow"),t.fadeIn("slow")}})}})}})}),c(".remove-date").live("click",function(){var e=c(this),a=e.parents(".edit-opening-times-item"),t=e.parent(".exception-item");e.fadeOut("slow"),a.find(".ajax-loader").fadeIn("slow"),a.find(".admin-error").remove(),"undefined"!==t.attr("id")&&""!==t.attr("id")?p.trashAsset({asset_ids:t.attr("id"),dataCallback:function(e){e.error&&a.append("<p class='admin-error'>There was an error removing this exception. Please try again.</p>"),t.fadeOut("slow").remove(),a.find(".ajax-loader").fadeOut("slow")}}):(t.fadeOut("slow").remove(),a.find(".ajax-loader").fadeOut("slow"))}),n.datepicker({dateFormat:"dd-mm-yy",beforeShowDay:function(e){var a,t,s=c(this).parents("li").data("library-day"),n=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],r=[[1],[2],[3],[4],[5],[6],[0]],i=[],d=e.getDay();for(a=0;a<n.length;a+=1)n[a]!==s&&i.push(r[a]);for(t=0;t<i.length;t+=1)if(d===i[t][0])return[!1];return[!0]}}),c("#notice-text .action-button").click(function(){!function(){var e=c("#notice-text textarea"),a=c("#notice-text .action-button");a.hide(),e.after('<img class="ajax-loader-notice" src="https://libraryservices.city.ac.uk/__data/assets/git_bridge/0004/841405/main/i/ajax-loader-small-red.gif">'),p.setMetadataAllFields({asset_id:i,field_info:{126957:e.val()},dataCallback:function(){c("#notice-text .ajax-loader-notice").remove(),a.show()}})}()})}}}(jQuery);libraryAdmin.init();